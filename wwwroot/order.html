<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Tạo đơn hàng</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Inter', sans-serif;
    background: #f9faff;
    min-height: 100vh;
    padding: 30px 20px;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 50px;
    padding-bottom: 15px; 
    border-bottom: 3px solid #E0E7FF; 
  }
  
  
  header h1 {
    font-size: 44px; 
    font-weight: 800; 
    color: #4F46E5; 
    text-shadow: 1px 1px 3px rgba(0,0,0,0.1); 
  }
  
  #authBtn {
    padding: 14px 34px;
    border-radius: 16px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
  }
  .login-btn { background:#4F46E5; color:white; border:none; }
  .logout-btn { background:#E0E7FF; color:#4F46E5; border:1px solid #C7D2FE; }
  #authBtn:hover { transform:translateY(-2px); }

  .main {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 40px;
  }
  @media (max-width: 992px) {
    .main { grid-template-columns: 1fr; }
  }

  /* Danh sách sản phẩm */
  .products h2 {
    font-size: 26px;
    margin-bottom: 24px;
    color: #1e1b4b;
  }
  .product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
    gap: 24px;
  }
  .product-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 20px;
    padding: 24px;
    transition: all 0.3s;
  }
  .product-card:hover {
    border-color: #4F46E5;
    box-shadow: 0 10px 30px rgba(79,70,229,0.1);
  }
  .product-card h3 {
    font-size: 19px;
    margin-bottom: 8px;
    color: #111;
  }
  .price {
    font-size: 24px;
    font-weight: 700;
    color: #4F46E5;
    margin: 12px 0;
  }
  .product-card p {
    font-size: 14.5px;
    color: #64748b;
    line-height: 1.5;
    margin-bottom: 18px;
  }
  .quantity-input {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .quantity-input input {
    width: 82px;
    padding: 11px;
    border: 1px solid #cbd5e1;
    border-radius: 12px;
    text-align: center;
    font-weight: 600;
  }
  .add-btn {
    flex: 1;
    padding: 13px;
    background: #4F46E5;
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s;
  }
  .add-btn:hover { background:#4338CA; }
  .add-btn:disabled {
    background:#94a3b8;
    cursor:not-allowed;
  }

  /* GIỎ HÀNG – ĐẸP & THUẬN MẮT */
  .cart {
    background: white;
    border-radius: 24px;
    padding: 32px;
    border: 2px solid #4F46E5;
    box-shadow: 0 12px 40px rgba(79,70,229,0.15);
    height: fit-content;
    position: sticky;
    top: 20px;
  }
  .cart h2 {
    font-size: 28px;
    color: #4F46E5;
    margin-bottom: 24px;
    text-align: center;
  }
  #cartItems {
    max-height: 500px;
    overflow-y: auto;
    margin-bottom: 24px;
    padding-right: 8px;
  }
  .cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0;
    border-bottom: 1px dashed #e2e8f0;
  }
  .cart-item:last-child { border-bottom: none; }
  .cart-item-name {
    font-weight: 600;
    flex: 1;
  }
  .cart-item-price {
    color: #4F46E5;
    font-weight: 700;
    margin-left: 16px;
  }
  .remove-btn {
    background: none;
    border: none;
    color: #ef4444;
    font-size: 20px;
    cursor: pointer;
    padding: 0 8px;
  }

  .cart-total {
    font-size: 26px;
    font-weight: 700;
    text-align: right;
    padding: 20px 0;
    color: #1e1b4b;
    border-top: 2px solid #e2e8f0;
  }

  #checkoutBtn {
    width: 100%;
    padding: 18px;
    background: #4F46E5;
    color: white;
    border: none;
    border-radius: 16px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
  }
  #checkoutBtn:hover { background:#4338CA; transform:translateY(-3px); }
  #checkoutBtn:disabled {
    background:#94a3b8;
    cursor:not-allowed;
  }

  #orderSuccess {
    background: #ecfdf5;
    border: 1px solid #86efac;
    color: #059669;
    padding: 24px;
    border-radius: 16px;
    text-align: center;
    margin-top: 20px;
    display: none;
  }
  #orderSuccess a {
    color: #4F46E5;
    font-weight: 700;
    text-decoration: underline;
  }

  .alert {
    padding: 14px 20px;
    border-radius: 12px;
    margin: 20px 0;
    font-weight: 500;
  }
  .alert-success { background:#ecfdf5; color:#059669; border:1px solid #86efac; }
  .alert-error { background:#fef2f2; color:#dc2626; border:1px solid #fca5a5; }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Tạo đơn hàng</h1>
    <button id="authBtn" class="login-btn">Đăng nhập</button>
  </header>

  <div id="globalAlert"></div>

  <div class="main">
    <div class="products">
      <h2>Danh sách sản phẩm</h2>
      <div class="product-grid" id="productList"></div>
    </div>

    <div class="cart">
      <h2>Giỏ hàng (<span id="cartCount">0</span>)</h2>
      <div id="cartItems">
        <p style="text-align:center;color:#94a3b8;">Chưa có sản phẩm nào</p>
      </div>
      <div class="cart-total">Tổng tiền: <span id="totalAmount">0</span>đ</div>
      <button id="checkoutBtn" disabled>Thanh toán ngay</button>

      <div id="orderSuccess">
        <h3>Đặt hàng thành công!</h3>
        <p>Mã đơn hàng: <strong id="orderIdDisplay"></strong></p>
        <p><a id="orderLink" href="#" target="_blank">Xem chi tiết đơn hàng</a></p>
      </div>
    </div>
  </div>
</div>

<script>
const API_URL = "https://localhost:5058/api";
const token = localStorage.getItem("token");
let cart = [];

function updateAuthButton() {
  const btn = document.getElementById("authBtn");
  if (token) {
    btn.textContent = "Đăng xuất";
    btn.className = "logout-btn";
    btn.onclick = () => { localStorage.clear(); location.reload(); };
  } else {
    btn.textContent = "Đăng nhập";
    btn.className = "login-btn";
    btn.onclick = () => location.href = "login.html";
  }
}

function showAlert(msg, type = "error") {
  document.getElementById("globalAlert").innerHTML = 
    `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(() => document.getElementById("globalAlert").innerHTML = "", 5000);
}

async function loadProducts() {
  try {
    const res = await fetch(`${API_URL}/products`);
    if (!res.ok) throw new Error("Không tải được sản phẩm");
    const products = await res.json();

    const grid = document.getElementById("productList");
    grid.innerHTML = "";

    products.forEach(p => {
      const card = document.createElement("div");
      card.className = "product-card";
      card.innerHTML = `
        <h3>${p.title || p.name}</h3>
        <div class="price">${Number(p.price).toLocaleString()}đ</div>
        <p>${(p.description||"").substring(0,100)}${(p.description||"").length>100?"...":""}</p>
        <div class="quantity-input">
          <input type="number" min="1" value="1" id="qty-${p.id}">
          <button class="add-btn" ${!token?'disabled':''} 
            onclick="addToCart(${p.id}, '${(p.title||p.name).replace(/'/g,"\\'")}', ${p.price})">
            ${token ? 'Thêm vào giỏ' : 'Đăng nhập để mua'}
          </button>
        </div>
      `;
      grid.appendChild(card);
    });
  } catch (err) {
    showAlert("Lỗi tải sản phẩm: " + err.message);
  }
}

function addToCart(id, title, price) {
  if (!token) return showAlert("Vui lòng đăng nhập để mua hàng");
  const qty = parseInt(document.getElementById(`qty-${id}`).value) || 1;
  if (qty < 1) return showAlert("Số lượng phải ≥ 1");

  const existing = cart.find(i => i.id === id);
  if (existing) existing.quantity += qty;
  else cart.push({ id, title, price, quantity: qty });

  updateCart();
  showAlert(`Đã thêm "${title}" vào giỏ hàng`, "success");
}

function removeFromCart(i) {
  cart.splice(i, 1);
  updateCart();
}

function updateCart() {
  const count = cart.reduce((s,i)=>s+i.quantity,0);
  const total = cart.reduce((s,i)=>s+i.price*i.quantity,0);

  document.getElementById("cartCount").textContent = count;
  document.getElementById("totalAmount").textContent = total.toLocaleString();

  const items = document.getElementById("cartItems");
  if (cart.length === 0) {
    items.innerHTML = "<p style='text-align:center;color:#94a3b8;'>Chưa có sản phẩm nào</p>";
    document.getElementById("checkoutBtn").disabled = true;
    return;
  }
  document.getElementById("checkoutBtn").disabled = false;

  items.innerHTML = "";
  cart.forEach((item, idx) => {
    const div = document.createElement("div");
    div.className = "cart-item";
    div.innerHTML = `
      <div class="cart-item-name">${item.title} × ${item.quantity}</div>
      <div class="cart-item-price">${(item.price*item.quantity).toLocaleString()}đ</div>
      <button class="remove-btn" onclick="removeFromCart(${idx})">×</button>
    `;
    items.appendChild(div);
  });
}

async function createOrder() {
  if (!token || cart.length === 0) return;

  const items = cart.map(i => ({
    productId: i.id,
    quantity: i.quantity,
    unitPrice: i.price
  }));

  try {
    const res = await fetch(`${API_URL}/orders`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ items })
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.message || "Đặt hàng thất bại");
    }

    const order = await res.json();
    const orderId = order.id || order.orderId;

    document.getElementById("orderIdDisplay").textContent = orderId;
    document.getElementById("orderLink").href = `order-detail.html?id=${orderId}`;
    document.getElementById("orderLink").textContent = `Xem chi tiết đơn hàng #${orderId}`;
    document.getElementById("orderSuccess").style.display = "block";

    cart = [];
    updateCart();
    showAlert("Đặt hàng thành công!", "success");

  } catch (err) {
    showAlert(err.message);
  }
}

updateAuthButton();
loadProducts();
updateCart();
document.getElementById("checkoutBtn").onclick = createOrder;
</script>

</body>
</html>