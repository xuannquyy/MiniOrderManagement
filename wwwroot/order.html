<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Mua hàng - MiniOrder</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
    
    * { 
        margin: 0; 
        padding: 0; 
        box-sizing: border-box; 
    }
    
    body { 
        font-family: 'Inter', sans-serif; 
        background: #F3F4F6; 
        padding: 20px; 
        color: #1F2937;
    }
    
    .container { 
        max-width: 1200px; 
        margin: 0 auto; 
    }
    
    
    header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 30px; 
        border-bottom: 1px solid #E5E7EB; 
        padding-bottom: 15px; 
    }
    
    
    .btn { 
        padding: 10px 18px; 
        border-radius: 8px; 
        text-decoration: none; 
        color: white; 
        font-weight: 600; 
        background: #4F46E5; 
        border: none; 
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 14px;
    }
    .btn:hover {
        background: #4338CA;
    }

    .btn-outline { 
        background: white; 
        color: #4F46E5; 
        border: 1px solid #4F46E5; 
        margin-right: 10px;
    }
    .btn-outline:hover {
        background: #F0F5FF;
    }
    
    
    .grid { 
        display: grid; 
        grid-template-columns: 1fr 350px; 
        gap: 30px; 
    }

    
    .products { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
        gap: 20px; 
    }
    
    .card { 
        background: white; 
        padding: 20px; 
        border-radius: 12px; 
        border: 1px solid #E5E7EB; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .card h3 { 
        margin-bottom: 10px; 
        font-size: 18px;
    }
    
    .price { 
        color: #4F46E5; 
        font-weight: bold; 
        font-size: 20px; 
        margin-bottom: 10px;
    }

    .card input[type="number"] {
        width: 60px; 
        padding: 6px;
        border: 1px solid #D1D5DB;
        border-radius: 6px;
        text-align: center;
        margin-right: 5px;
    }

   
    .cart { 
        background: white; 
        padding: 25px; 
        border-radius: 16px; 
        height: fit-content; 
        border: 2px solid #4F46E5; 
        position: sticky; 
        top: 20px;
        box-shadow: 0 4px 10px rgba(79, 70, 229, 0.1);
    }

    .cart h2 {
        font-size: 20px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #E5E7EB;
    }
    
    .cart-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        border-bottom: 1px dashed #D1D5DB; 
        padding: 10px 0; 
        font-size: 14px;
    }

    .cart-item span:last-child {
        color: #EF4444; 
        cursor: pointer;
        padding: 0 5px;
        font-weight: 600;
    }

    .cart h3 {
        color: #111;
        font-size: 22px;
    }

    .cart .btn {
        margin-top: 15px;
        padding: 12px;
        font-size: 16px;
    }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1><i class="fa-solid fa-store"></i> Mua sắm</h1>
    <div>
      <a href="my-order.html" class="btn btn-outline" id="historyBtn" style="display:none"><i class="fa-solid fa-clock-rotate-left"></i> Lịch sử đơn</a>
      <a href="admin.html" class="btn btn-outline" id="adminBtn" style="display:none"><i class="fa-solid fa-screwdriver-wrench"></i> Trang Admin</a>
      <button id="authBtn" class="btn" onclick="handleAuth()"><i class="fa-solid fa-user-circle"></i> Đăng nhập</button>
    </div>
  </header>

  <div class="grid">
    <div class="products" id="productList">Loading...</div>
    
    <div class="cart">
      <h2>Giỏ hàng (<span id="count">0</span>)</h2>
      <div id="cartItems">Chưa có gì</div>
      <h3 style="margin-top:20px; text-align:right">Tổng: <span id="total">0</span>đ</h3>
      <button onclick="checkout()" class="btn" style="width:100%; margin-top:15px"><i class="fa-solid fa-credit-card"></i> Thanh toán</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://localhost:7288/api";
const token = localStorage.getItem("token");
let cart = [];

function parseJwt(token) { try { return JSON.parse(decodeURIComponent(window.atob(token.split('.')[1]).replace(/-/g, '+').replace(/_/g, '/').split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''))); } catch (e) { return null; } }

// Setup giao diện
if (token) {
    document.getElementById("authBtn").textContent = "Đăng xuất";
    document.getElementById("historyBtn").style.display = "inline-block";
    
    const decoded = parseJwt(token);
    const role = decoded["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"] || decoded["role"];
    if(role === "Admin") document.getElementById("adminBtn").style.display = "inline-block";
}

function handleAuth() {
    if(token) { localStorage.clear(); location.href = "login.html"; }
    else location.href = "login.html";
}

async function loadProducts() {
    const res = await fetch(`${API_URL}/products`);
    const products = await res.json();
    document.getElementById("productList").innerHTML = products.map(p => `
        <div class="card">
            <h3>${p.name}</h3>
            <p style="color:#6B7280; margin-bottom: 5px;">Kho: ${p.stock}</p>
            <div class="price">${p.price.toLocaleString()}đ</div>
            
            <div style="margin-top:10px; display: flex; align-items: center;">
                <input type="number" id="qty-${p.id}" value="1" min="1">
                <button class="btn" onclick="add(${p.id}, '${p.name}', ${p.price})"><i class="fa-solid fa-plus"></i> Thêm</button>
            </div>
        </div>
    `).join('');
}

function add(id, name, price) {
    if(!token) return alert("Đăng nhập đi bạn ơi!");
    const qty = parseInt(document.getElementById(`qty-${id}`).value);
    
    if (qty <= 0 || isNaN(qty)) return alert("Số lượng không hợp lệ!");

    const exist = cart.find(x => x.id === id);
    if(exist) exist.qty += qty;
    else cart.push({ id, name, price, qty });
    renderCart();
}

function renderCart() {
    document.getElementById("count").textContent = cart.reduce((a,b)=>a+b.qty, 0);
    document.getElementById("total").textContent = cart.reduce((a,b)=>a+(b.price*b.qty), 0).toLocaleString();
    
    if (cart.length === 0) {
        document.getElementById("cartItems").innerHTML = `<p style="color:#6B7280; text-align:center; padding: 15px 0;">Giỏ hàng trống</p>`;
    } else {
        document.getElementById("cartItems").innerHTML = cart.map((x, i) => `
            <div class="cart-item">
                <span>${x.name} x ${x.qty}</span>
                <span style="font-weight: 600;">${(x.price * x.qty).toLocaleString()}đ</span>
                <span onclick="cart.splice(${i},1); renderCart()" title="Xóa sản phẩm này">
                    <i class="fa-solid fa-xmark"></i>
                </span>
            </div>
        `).join('');
    }
}

async function checkout() {
    if(cart.length === 0) return alert("Giỏ hàng trống!");
    if(!token) return alert("Vui lòng đăng nhập để thanh toán!");
    
    // CHỈ GỬI ProductId và Quantity (Không gửi Price)
    const payload = {
        items: cart.map(i => ({
            productId: i.id,
            quantity: i.qty
        }))
    };

    const res = await fetch(`${API_URL}/order`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
        body: JSON.stringify(payload)
    });

    if(res.ok) {
        const data = await res.json();
        alert("Đặt hàng thành công! Mã đơn: " + (data.orderId || data.id));
        cart = []; renderCart();
        // Cần đảm bảo loadProducts() được gọi lại để cập nhật Stock
        loadProducts(); 
        location.href = "my-order.html"; // Chuyển sang trang lịch sử
    } else {
        const err = await res.json();
        const errorMessage = (err.message || (Array.isArray(err) && err[0]) || "Có gì đó sai sai").toString();
        alert("Lỗi thanh toán: " + errorMessage);
    }
}

loadProducts();
</script>
</body>
</html>